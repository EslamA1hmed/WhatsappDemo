<div class="create-template-layout">
  <!-- Form Section -->
  <div class="form-section">
    <div class="create-template-container">
      <h2>Create WhatsApp Template</h2>
      <form (ngSubmit)="onSubmit()" #templateForm="ngForm">
        <div class="form-group">
          <label>Template Name</label>
          <input type="text" [(ngModel)]="template.name" name="name" required 
                 placeholder="Enter template name (lowercase, underscores only)" 
                 pattern="[a-z0-9_]+" title="Only lowercase letters, numbers, and underscores allowed"/>
        </div>
        
        <div class="form-group">
          <label>Category</label>
          <select [(ngModel)]="template.category" name="category" (ngModelChange)="onCategoryChange()">
            <option value="MARKETING">Marketing</option>
            <option value="UTILITY">Utility</option>
            <option value="AUTHENTICATION">Authentication</option>
          </select>
        </div>

        <div class="form-group">
          <label>Language</label>
          <select [(ngModel)]="template.language" name="language" required>
            <option value="en_US">English - United States</option>
            <option value="ar">Arabic</option>
            <option value="en_GB">English - UK</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="pt_BR">Portuguese - Brazil</option>
          </select>
        </div>

        <!-- HEADER Section (Hidden for AUTHENTICATION) -->
        <section class="component-section" *ngIf="template.category !== 'AUTHENTICATION'">
          <h3>📋 Header (optional)</h3>
          <div *ngIf="template.components && template.components[0] as headerComp">
            <div class="form-group">
              <label>Header Type</label>
              <select [(ngModel)]="headerComp.format" name="headerFormat" (ngModelChange)="onHeaderFormatChange()">
                <option value="TEXT">📝 Text</option>
                <option value="IMAGE">🖼️ Image</option>
                <option value="VIDEO">🎥 Video</option>
                <option value="DOCUMENT">📄 Document</option>
              </select>
            </div>

            <!-- Text Header -->
            <div *ngIf="headerComp.format === 'TEXT'" class="form-group">
              <textarea #headerText [(ngModel)]="headerComp.text" name="headerText"
                        placeholder="Enter header text (max 60 chars, you can insert one variable like {{1}})"
                        rows="2" maxlength="60" 
                        (keydown)="onHeaderKeydown($event)" 
                        (ngModelChange)="onHeaderTextChange($event)"></textarea>
              <small class="char-count">{{headerComp.text?.length || 0}}/60 characters</small>
            </div>

            <!-- Media Header -->
            <div *ngIf="headerComp.format !== 'TEXT' && headerComp.format" class="form-group">
              <label>Media File</label>
              <input type="file" (change)="onMediaFileChange($event)" [accept]="getAcceptType(headerComp.format)" />
            </div>

            <!-- Variables for Header (Text Only) -->
            <div *ngIf="headerComp.format === 'TEXT'" class="vars-block">
              <button type="button" class="btn-variable" (click)="addVariable('HEADER')"
                      *ngIf="headerComp.variables!.length === 0">
                ➕ Add Variable
              </button>
              
              <div *ngFor="let v of headerComp.variables; let i = index" class="var-row">
                <label class="var-label">{{ v.placeholder }}</label>
                <input [(ngModel)]="v.example" [name]="'headerVar' + i"
                       placeholder="Example for {{ v.placeholder }}"
                       required />
                <button type="button" class="btn-remove" (click)="removeVariable('HEADER', i)" title="Remove variable">
                  ❌
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- BODY Section -->
        <section class="component-section">
          <h3>📄 Body * (required)</h3>
          <div *ngIf="template.components && template.components[1] as bodyComp">
            <!-- Non-Authentication Body -->
            <div *ngIf="template.category !== 'AUTHENTICATION'" class="form-group">
              <textarea #bodyText [(ngModel)]="bodyComp.text" name="bodyText" 
                        placeholder="Enter body text (max 1024 chars, use {{1}} for variables)"
                        rows="4" maxlength="1024" required 
                        (keydown)="onBodyKeydown($event)" 
                        (ngModelChange)="onBodyTextChange($event)"></textarea>
              <small class="char-count">{{bodyComp.text?.length || 0}}/1024 characters</small>
            </div>
            <!-- Authentication Body -->
            <div *ngIf="template.category === 'AUTHENTICATION'" class="note-text">
              🔐 Authentication templates use a fixed body text: "{{1}} is your verification code".
            </div>

            <div class="vars-block" *ngIf="template.category !== 'AUTHENTICATION'">
              <button type="button" class="btn-variable" (click)="addVariable('BODY')">
                ➕ Add Variable
              </button>
              
              <div *ngFor="let v of bodyComp.variables; let i = index" class="var-row">
                <label class="var-label">{{ v.placeholder }}</label>
                <input [(ngModel)]="v.example" [name]="'bodyVar' + i" 
                       placeholder="Example for {{ v.placeholder }} (e.g., 123456 for OTP)" 
                       required />
                <button type="button" class="btn-remove" (click)="removeVariable('BODY', i)" title="Remove variable">
                  ❌
                </button>
              </div>
            </div>

            <!-- AUTHENTICATION Specific Fields -->
            <div *ngIf="template.category === 'AUTHENTICATION'" class="vars-block">
              <div class="checkbox-group">
                <input type="checkbox" [(ngModel)]="bodyComp.add_security_recommendation" 
                       name="securityRecommendation" id="securityRecommendation" />
                <label for="securityRecommendation">Add Security Recommendation</label>
              </div>
            </div>
          </div>
        </section>

        <!-- FOOTER Section -->
        <section class="component-section">
          <h3>🔗 Footer (optional)</h3>
          <div *ngIf="template.components && template.components[2] as footerComp">
            <div class="form-group" *ngIf="template.category !== 'AUTHENTICATION'">
              <textarea [(ngModel)]="footerComp.text" name="footerText" 
                        placeholder="Enter footer text (max 60 chars)"
                        rows="2" maxlength="60"></textarea>
              <small class="char-count">{{footerComp.text?.length || 0}}/60 characters</small>
            </div>
            <div *ngIf="template.category === 'AUTHENTICATION'" class="form-group">
              <label>Code Expiration (minutes)</label>
              <input type="number" [(ngModel)]="footerComp.code_expiration_minutes" 
                     name="codeExpiration" min="1" max="1440"
                     placeholder="e.g., 10" />
            </div>
          </div>
        </section>

        <!-- BUTTONS Section -->
        <section class="component-section">
          <h3>🔘 Buttons (optional)</h3>
          <div *ngIf="template.components && template.components[3] as buttonsComp">
            <div class="vars-block">
              <button type="button" class="btn-add-button" (click)="addButton()" 
                      [disabled]="buttonsComp.buttons && buttonsComp.buttons.length >= (template.category === 'AUTHENTICATION' ? 1 : 10)">
                ➕ Add Button (Max: {{ template.category === 'AUTHENTICATION' ? 1 : 10 }})
              </button>
              
              <div *ngFor="let btn of buttonsComp.buttons; let i = index" class="button-row">
                <select class="button-type-select" [(ngModel)]="btn.type" [name]="'buttonType' + i" 
                        (ngModelChange)="onButtonTypeChange(i)">
                  <option value="OTP" *ngIf="template.category === 'AUTHENTICATION'">OTP</option>
                  <option value="QUICK_REPLY" *ngIf="template.category !== 'AUTHENTICATION'">Quick Reply</option>
                  <option value="URL" *ngIf="template.category !== 'AUTHENTICATION'">URL</option>
                  <option value="PHONE_NUMBER" *ngIf="template.category !== 'AUTHENTICATION'">Phone Number</option>
                </select>

                <!-- Quick Reply Button -->
                <div *ngIf="btn.type === 'QUICK_REPLY'" class="form-group">
                  <label>Button Text</label>
                  <input [(ngModel)]="btn.text" [name]="'buttonText' + i"
                         placeholder="Button text (e.g., Yes, No, Maybe)" 
                         maxlength="25" required />
                  <small class="char-count">{{btn.text?.length || 0}}/25 characters</small>
                </div>

                <!-- URL Button -->
                <div *ngIf="btn.type === 'URL'" class="form-group">
                  <label>Button Text</label>
                  <input [(ngModel)]="btn.text" [name]="'buttonText' + i"
                         placeholder="Button text (e.g., Visit Website)" 
                         maxlength="25" required />
                  <small class="char-count">{{btn.text?.length || 0}}/25 characters</small>
                  
                  <label>URL</label>
                  <input [(ngModel)]="btn.url" [name]="'buttonUrl' + i"
                         placeholder="https://example.com/{{1}}" 
                         type="url" required />
                  <div class="vars-block">
                    <button type="button" class="btn-variable" (click)="addButtonVariable(i)"
                            *ngIf="getButtonVariables(btn).length === 0">
                      ➕ Add URL Variable
                    </button>
                    <div *ngFor="let v of getButtonVariables(btn); let vi = index" class="var-row">
                      <label class="var-label">{{ v.placeholder }}</label>
                      <input [(ngModel)]="v.example" [name]="'buttonUrlVar' + i + vi"
                             placeholder="Example for {{ v.placeholder }} (e.g., summer2023)"
                             required />
                      <button type="button" class="btn-remove" (click)="removeButtonVariable(i, vi)" title="Remove variable">
                        ❌
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Phone Number Button -->
                <div *ngIf="btn.type === 'PHONE_NUMBER'" class="form-group">
                  <label>Button Text</label>
                  <input [(ngModel)]="btn.text" [name]="'buttonText' + i"
                         placeholder="Button text (e.g., Call Us)" 
                         maxlength="25" required />
                  <small class="char-count">{{btn.text?.length || 0}}/25 characters</small>
                  
                  <label>Phone Number</label>
                  <input [(ngModel)]="btn.phone_number" [name]="'buttonPhone' + i"
                         placeholder="+1234567890" 
                         pattern="^\+[1-9]\d{1,14}$" required />
                </div>

                <!-- OTP Button -->
                <div *ngIf="btn.type === 'OTP'" class="form-group">
                  <label>OTP Type</label>
                  <select [(ngModel)]="btn.otp_type" [name]="'otpType' + i">
                    <option value="COPY_CODE">Copy Code</option>
                    <option value="ONE_TAP">One-Tap</option>
                  </select>
                  <div *ngIf="btn.otp_type === 'ONE_TAP'" class="form-group">
                    <label>Autofill Text</label>
                    <input [(ngModel)]="btn.autofill_text" [name]="'autofillText' + i"
                           placeholder="Autofill" />
                    
                    <label>Package Name (Android)</label>
                    <input [(ngModel)]="btn.package_name" [name]="'packageName' + i"
                           placeholder="com.example.app" />
                    
                    <label>Signature Hash</label>
                    <input [(ngModel)]="btn.signature_hash" [name]="'signatureHash' + i"
                           placeholder="App signature hash" />
                  </div>
                </div>

                <button type="button" class="btn-remove" (click)="removeButton(i)" title="Remove button">
                  ❌ Remove
                </button>
              </div>

              <div *ngIf="!buttonsComp.buttons || buttonsComp.buttons.length === 0" class="note-text">
                💡 Buttons are optional. You can add up to {{ template.category === 'AUTHENTICATION' ? 1 : 10 }} buttons.
              </div>

              <div *ngIf="template.category === 'AUTHENTICATION' && buttonsComp.buttons && buttonsComp.buttons.length > 1" 
                   class="note-text">
                ⚠️ Authentication templates can only have one OTP button.
              </div>
            </div>
          </div>
        </section>

        <button type="submit" class="btn-submit" [disabled]="!isFormValid()">
          🚀 Create Template
        </button>
      </form>

      <div *ngIf="successMessage" class="alert alert-success">
        ✅ {{ successMessage }}
      </div>
      <div *ngIf="errorMessage" class="alert alert-error">
        ❌ {{ errorMessage }}
      </div>
    </div>
  </div>

  <!-- Preview Section -->
  <div class="preview-section">
    <div class="whatsapp-preview">
      <div class="whatsapp-header">
        <div class="contact-info">
          <div class="avatar"></div>
          <div class="contact-details">
            <h4>Business Account</h4>
            <span>Template Preview</span>
          </div>
        </div>
        <div class="header-actions">
          <div class="header-dots">⋮</div>
        </div>
      </div>
      
      <div class="chat-area">
        <div class="message-bubble" [ngClass]="{'rtl': isPreviewRTL()}" *ngIf="hasPreviewContent()">
          
          <!-- Header Preview -->
          <ng-container *ngIf="template.category !== 'AUTHENTICATION'">
            <div class="message-header" *ngIf="template.components && template.components[0] as headerComp" [ngClass]="{'rtl': isPreviewRTL()}">
              <div *ngIf="headerComp.format === 'TEXT' && headerComp.text" class="header-text">
                {{ renderPreview('HEADER') }}
              </div>
              <div *ngIf="headerComp.format === 'IMAGE' && getMediaPreviewUrl('HEADER')" class="media-preview">
                <img [src]="getMediaPreviewUrl('HEADER')" alt="Header Image" (error)="handleMediaError($event, 'HEADER')">
                <div class="media-placeholder" [style.display]="headerComp.mediaError ? 'block' : 'none'">🖼️ Image Preview</div>
              </div>
              <div *ngIf="headerComp.format === 'VIDEO' && getMediaPreviewUrl('HEADER')" class="media-preview">
                <video [src]="getMediaPreviewUrl('HEADER')" controls (error)="handleMediaError($event, 'HEADER')">
                </video>
                <div class="media-placeholder" [style.display]="headerComp.mediaError ? 'block' : 'none'">🎥 Video Preview</div>
              </div>
              <div *ngIf="headerComp.format === 'DOCUMENT' && getMediaPreviewUrl('HEADER')" class="media-preview">
                <div class="document-icon">📄</div>
                <span>{{ getMediaFileName(getMediaPreviewUrl('HEADER')) }}</span>
              </div>
            </div>
          </ng-container>

          <!-- Body Preview -->
          <div class="message-body" *ngIf="template.components && template.components[1] as bodyComp" 
               [ngClass]="{'rtl': isRTL(renderPreview('BODY'))}">
            <div *ngFor="let line of renderBodyPreviewLines()" class="body-line">
              {{ line }}
            </div>
            <div *ngIf="template.category === 'AUTHENTICATION'" class="body-line">
              {{1}} is your verification code
            </div>
            <div *ngIf="template.category === 'AUTHENTICATION' && bodyComp.add_security_recommendation" 
                 class="body-line">
              For your security, do not share this code.
            </div>
          </div>

          <!-- Footer Preview -->
          <ng-container *ngIf="template.components && template.components[2] as footerComp">
            <div class="message-footer" *ngIf="footerComp.text || (template.category === 'AUTHENTICATION' && footerComp.code_expiration_minutes)" 
                 [ngClass]="{'rtl': isRTL(footerComp.text || '')}">
              {{ footerComp.text }}
              <div *ngIf="template.category === 'AUTHENTICATION' && footerComp.code_expiration_minutes">
                This code expires in {{ footerComp.code_expiration_minutes }} minutes.
              </div>
            </div>
          </ng-container>

          <!-- Buttons Preview -->
          <ng-container *ngIf="template.components && template.components[3] as buttonsComp">
            <div class="button-preview" *ngIf="buttonsComp.buttons && buttonsComp.buttons.length > 0"
                 [ngClass]="{'rtl': isPreviewRTL()}">
              <button *ngFor="let btn of buttonsComp.buttons" 
                      [ngClass]="{'rtl-button': isPreviewRTL()}">
                {{ renderButtonText(btn) }}
              </button>
            </div>
          </ng-container>

          <div class="message-time">{{ getCurrentTime() }} ✓✓</div>
        </div>

        <div class="no-preview" *ngIf="!hasPreviewContent()">
          <div class="no-preview-icon">💬</div>
          <p>Start creating your template</p>
          <small>Fill in the form to see preview</small>
        </div>
      </div>
    </div>
  </div>
</div>
